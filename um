#!/usr/bin/env python
"""Undermountain Startup Script"""
from logging.handlers import RotatingFileHandler
from mud.game import Game
import gevent
import logging
import sys
import settings


def get_python_version():
    major, minor, micro, _, _ = sys.version_info
    return '.'.join(map(str, [major, minor, micro]))


def setup_logging():
    """Set up the format and output of the logging module."""

    root_logger = logging.getLogger()
    root_logger.setLevel(logging.DEBUG)

    log_format = "%(asctime)-15s - %(levelname)s - %(message)s"
    formatter = logging.Formatter(log_format)

    log_file = RotatingFileHandler("log/undermountain.log")
    log_file.setFormatter(formatter)
    root_logger.addHandler(log_file)

    log_console = logging.StreamHandler()
    log_console.setFormatter(formatter)
    root_logger.addHandler(log_console)


def display_banner():
    engine_version = Game.get_version()
    python_version = get_python_version()
    banner_lines = ("""\
      __ _______
     /  /       \ """ + (64 * "-") + """
    /  /  /  /  /    Undermountain Python MUD Server v{} - Python v{}
    \____/__/__/ """ + (66 * "-") + "\n").format(
        engine_version, python_version).split("\n")

    for line in banner_lines:
        logging.info(line)


def start_game():
    display_banner()
    logging.info("Loaded settings from {}".format(settings.__file__))

    GAME = Game(settings)
    try:
        task = gevent.spawn(GAME.start)
        task.join()
    except KeyboardInterrupt:
        GAME.stop()

def display_help():
    display_banner()
    [logging.info(line) for line in [
        "Commands:",
        "./um start - Start the game",
        "./um backup [id] - Backup data with identifier",
        "./um restore <id> - Restore data with identifier",
        "",
        "For backups, see the 'backups' folder",
    ]]
    sys.exit(1)

setup_logging()
ARGS = sys.argv
if len(ARGS) == 1:
    display_help()
elif ARGS[1] == "start":
    start_game()
else:
    display_help()
